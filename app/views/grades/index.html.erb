<%= stylesheet_link_tag 'grades' %>

<script type="text/javascript" src="/javascripts/stats.js"></script>
<script type="text/javascript">
$(document).ready(function(e) {

	$('.item_row').click(function(e) {
		var item_id = $(this).attr('data-id');
		$.ajax({
		  type: 'GET',
		  url: '/items/histogram/' + item_id + '.json',
		  success: function(data) {
		  	if (data.length == 0) {
		  		$('#histogram_container').fadeOut(300);
		  		return;
		  	}
		  	var categories = [],
		  		points = [];
		  	for (var i=0; i<data['points'].length; i++) {
		  		categories[i] = data['points'][i]['range'][0] + '-' + data['points'][i]['range'][1]
		  		points[i] = data['points'][i]['freq'];
		  	}
		  	
		  	var mean = data['mean'], 
		  		std_dev = data['std_dev'];
		  	var title = data['title']
		  		subtitle = 'Mean: ' + mean + '\tStd. Dev: ' + std_dev;
		  	var opts = {
		  		points: points,
		  		title: title,
		  		subtitle: subtitle,
		  		categories: categories
		  	};
		  	
		  	$.histogram('histogram_container', opts);
		  	$('#histogram_container').fadeIn(300);
		  },
		  dataType: 'json'
		});
	});
	
	$('#remove_grades_button').hide()
	
	$('.destroy_checkbox').change(function(e) {
		var count = $('.destroy_checkbox:checked').length;
		if (count === 0) {
			$('#remove_grades_button').hide();
		} else if (!$('#remove_grades_button').is(':visible')) {
			$('#remove_grades_button').show()
		}
	});
	
});
</script>

<%= render '/layouts/nav', :navigation =>
  [["Courses", courses_path],
  ["#{@course.dept} #{@course.number}", @course],
  ["Grades", url_for(:controller => :grades, :action => :index)]] %>

<div id="content">	
	<form action="/grades/destroy" method="POST">
	<div id="notification" class="success notification"><%= params[:notification] %></div>
	<table id="grades_list">
	  <tr>
	  	<th>Item</th>
	  	<th class="align_right">Points</th>
	  	<th class="divide">/</th>
	  	<th>Possible</th>
	  	<th>%</th>
	  </tr>
	
	<% total_pts = 0
	 total_possible = 0 
	%>
	<% @grades.each do |grade| %>
	 <% if grade.item.course == @course %>
	  <% total_pts += grade.points_received
	  	 total_possible += grade.item.points
	  %>
	  <tr class="item_row" data-id="<%= grade.item.id %>">
	    <td><span class="item_name"><%= check_box_tag "grade_ids[]", grade.id, false, :class => "destroy_checkbox" %><%= grade.item.name %></span></td>
	    <td class="align_right"><%= format("%.2f", grade.points_received) %></td>
	    <td class="divide">/</td>
	    <td><%= grade.item.points %></td>
	    <% if grade.item.points != 0 %>
		  	<td><%= format("%.2f%%", ((grade.points_received)/(grade.item.points))*100) %></td>
		<% end %>
	  </tr>
	<% end %>
	<% end %>
	<% if total_possible != 0 %>
		<tr id="grade_totals">
			<td><input id="remove_grades_button" type="submit" value="Remove" /><%= link_to 'Enter New Grade', new_course_grade_path(@course), :id => "new_grade_link" %></td>
			<td class="align_right"><%= format("%.2f", total_pts) %></td>
			<td class="divide">/</td>
			<td><%= total_possible %></td>
		  	<td><%= format("%.2f%", (total_pts*100)/(total_possible)) %></td>
		</tr>
	<% end %>
	</table>
		<input name="authenticity_token" type="hidden" value="<%= form_authenticity_token %>" />
		<input type="hidden" name="course_id" value="<%= @course.to_param %>" />
	</form>
	<div id="histogram_container"></div>
	</div>
</div>